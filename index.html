<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Españord Redirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 60px;
    }
  </style>
</head>
<body>
  <h1>Loading...</h1>
  <p>Your Spanish learning adventure is about to begin!</p>

  <script>
    // --- Configuration ---
    const MAIN_DOMAIN = 'españord.com';
    const CANVA_DESTINATION_URL = 'https://españord.com';
    const AD_ID_PARAM = 'epik';
    const COOKIE_NAME = 'campaign_ad_id';
    const PINTEREST_TID = '2612894781060'; 
    // Unique ID for deduplication
    const EVENT_ID = 'pv_' + Date.now() + '_' + Math.random().toString(36).slice(2,9); 

    // Helper to send Pinterest beacon
    function sendPinterestBeacon(event, data) {
      try {
        // **CRITICAL FIX:** Using 'text/plain' to avoid sendBeacon CORS issues
        const beaconSent = navigator.sendBeacon("https://ct.pinterest.com/v3/",
          new Blob([JSON.stringify({
            event_name: event,
            action_source: "website",
            event_time: Math.floor(Date.now()/1000),
            event_id: EVENT_ID,
            tid: PINTEREST_TID,
            custom_data: data || {}, // Will contain the ad_id if present
            user_data: {}
          })], {type: 'text/plain'}));

        console.log(`[Bridge]: Beacon sent for ${event}. Success: ${beaconSent}`);
        return beaconSent;
      } catch (err) {
        console.warn("[Bridge]: Beacon error:", err);
        return false;
      }
    }

    // Get adId immediately
    function getAdId() {
      return new URLSearchParams(window.location.search).get(AD_ID_PARAM);
    }

    function fireEventsAndRedirect(adId) {
      // 1. Set cookie if adId exists
      if (adId) {
        document.cookie = `${COOKIE_NAME}=${adId}; domain=.${MAIN_DOMAIN}; path=/; max-age=604800; secure; samesite=Lax`;
      }

      // 2. Prepare Custom Data Payload
      let customData = {};
      if (adId) {
        // Only include ad_id if a value was found
        customData.ad_id = adId;
        console.log(`[Bridge]: Including ad_id: ${adId}`);
      } else {
        console.log(`[Bridge]: No ad_id found, sending standard PageVisit.`);
      }

      // 3. Fire Pinterest PageVisit
      sendPinterestBeacon("PageVisit", customData); 

      // 4. Redirect URL construction
      const redirectUrl = adId
        ? `${CANVA_DESTINATION_URL}?epik=${encodeURIComponent(adId)}`
        : CANVA_DESTINATION_URL;

      // **TIMING FIX:** Increased delay to 700ms for reliable beacon transmission
      setTimeout(() => {
        console.log("[Bridge]: Redirecting now.");
        window.location.replace(redirectUrl);
      }, 700);
    }

    // --- Main Execution Flow ---
    
    // Start the process immediately
    const initialAdId = getAdId();
    fireEventsAndRedirect(initialAdId);
    
  </script>
</body>
