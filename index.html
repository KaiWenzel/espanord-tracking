<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Espa√±ord Redirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 60px;
    }

    h1, p {
      opacity: 0;
      animation: fadeIn 0.8s ease-in-out forwards;
    }

    h1 {
      animation-delay: 0.1s;
    }

    p {
      animation-delay: 0.4s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .spinner {
      margin-top: 20px;
      width: 30px;
      height: 30px;
      border: 3px solid #ccc;
      border-top-color: #2b6cb0;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    // --- OFFICIAL PINTEREST BASE CODE (must be first in <head>) ---
    !function(e){
      if(!window.pintrk){
        window.pintrk=function(){window.pintrk.queue.push(Array.prototype.slice.call(arguments))};
        var n=window.pintrk;
        n.queue=[],n.version="3.0";
        var t=document.createElement("script");
        t.async=!0,t.src=e;
        var r=document.getElementsByTagName("script")[0];
        r.parentNode.insertBefore(t,r)
      }
    }("https://s.pinimg.com/ct/core.js");
  </script>
</head>
<body>
  <h1>Connecting you to your learning hub...</h1>
  <p>This might take a second.</p>
  <div class="spinner"></div>

  <script>
    // --- CONFIG ---
    const MAIN_DOMAIN = 'xn--espaord-7za.com';
    const CANVA_DESTINATION_URL = 'https://xn--espaord-7za.com';
    const AD_ID_PARAM = 'epik';
    const COOKIE_NAME = 'campaign_ad_id';
    const PINTEREST_TID = '2612894781060';
    const REDIRECT_FALLBACK_MS = 3000; // hard timeout (safety net)

    function getAdId() {
      return new URLSearchParams(window.location.search).get(AD_ID_PARAM);
    }

    // Get Ad ID immediately
function getAdId() {
    return new URLSearchParams(window.location.search).get(AD_ID_PARAM);
}

// Function to synchronously send the Pinterest PageVisit event
function sendPinterestEvent(adId) {
    if (!adId) {
        // If no adId, fire the standard Pinterest event (non-synchronous, as usual)
        pintrk('load', PINTEREST_TID);
        pintrk('track', 'PageVisit');
        console.log(`[Bridge]: Fired standard PageVisit (No EPK).`);
        return; 
    }
    
    // --- Manual Synchronous Event Sending ---
    const eventUrl = `https://ct.pinterest.com/v3/?tid=${PINTEREST_TID}&event=PageVisit&epk=${encodeURIComponent(adId)}&noscript=1`;
    
    try {
        const xhr = new XMLHttpRequest();
        // The third parameter 'false' makes the request synchronous
        xhr.open('GET', eventUrl, false); 
        xhr.send(null);
        console.log(`[Bridge]: Synchornous PageVisit sent with EPK: ${adId}. Status: ${xhr.status}`);
    } catch (e) {
        console.error("[Bridge]: Synchronous XHR failed.", e);
        // Fallback: Fire the standard pintrk event (better than nothing)
        pintrk('load', PINTEREST_TID);
        pintrk('track', 'PageVisit', { epk: adId });
    }
}

// --- Main Logic ---
const adId = getAdId();

// 1. Manually set cookie (still good to have for general persistence)
if (adId) {
    document.cookie = `${COOKIE_NAME}=${adId}; domain=.${MAIN_DOMAIN}; path=/; max-age=604800; secure; samesite=Lax`;
}

// 2. Send the attributed Pinterest event SYNCHRONOUSLY
sendPinterestEvent(adId);

// 3. Redirect immediately after the synchronous call completes
const redirectUrl = adId
    ? `${CANVA_DESTINATION_URL}?epik=${encodeURIComponent(adId)}`
    : CANVA_DESTINATION_URL;

console.log("[Bridge]: Redirecting now.");
// Redirect without a delay, as the synchronous call provided the necessary wait
window.location.replace(redirectUrl);
  </script>
</body>
</html>
