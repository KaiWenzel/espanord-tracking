<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Espa√±ord Redirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 60px;
    }

    h1, p {
      opacity: 0;
      animation: fadeIn 0.8s ease-in-out forwards;
    }

    h1 {
      animation-delay: 0.1s;
    }

    p {
      animation-delay: 0.4s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .spinner {
      margin-top: 20px;
      width: 30px;
      height: 30px;
      border: 3px solid #ccc;
      border-top-color: #2b6cb0;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    // --- OFFICIAL PINTEREST BASE CODE (must be first in <head>) ---
    !function(e){
      if(!window.pintrk){
        window.pintrk=function(){window.pintrk.queue.push(Array.prototype.slice.call(arguments))};
        var n=window.pintrk;
        n.queue=[],n.version="3.0";
        var t=document.createElement("script");
        t.async=!0,t.src=e;
        var r=document.getElementsByTagName("script")[0];
        r.parentNode.insertBefore(t,r)
      }
    }("https://s.pinimg.com/ct/core.js");
  </script>
</head>
<body>
  <h1>Connecting you to your learning hub...</h1>
  <p>This might take a second.</p>
  <div class="spinner"></div>

  <script>
    // --- CONFIG ---
    const MAIN_DOMAIN = 'xn--espaord-7za.com';
    const CANVA_DESTINATION_URL = 'https://xn--espaord-7za.com';
    const AD_ID_PARAM = 'epik';
    const COOKIE_NAME = 'campaign_ad_id';
    const PINTEREST_TID = '2612894781060';
    const REDIRECT_FALLBACK_MS = 3000; // hard timeout (safety net)

    function getAdId() {
      return new URLSearchParams(window.location.search).get(AD_ID_PARAM);
    }

    const adId = getAdId();
    pintrk('page');
    pintrk('load', PINTEREST_TID);

    let eventData = {};
    if (adId) {
      eventData = { epk: adId };
      console.log(`[Bridge]: Fired Pinterest PageVisit with EPK: ${adId}`);
    } else {
      console.log(`[Bridge]: Fired standard PageVisit.`);
    }

    // --- Send event and wait for completion ---
    const eventPromise = new Promise((resolve) => {
      try {
        // Send Pinterest request manually so we can detect completion
        navigator.sendBeacon
          ? resolve(pintrk('track', 'PageVisit', eventData)) // sendBeacon is async-safe
          : (pintrk('track', 'PageVisit', eventData), resolve());
      } catch (e) {
        console.warn('[Bridge]: Pinterest event failed silently.', e);
        resolve();
      }
    });

    // Store cookie if applicable
    if (adId) {
      document.cookie = `${COOKIE_NAME}=${adId}; domain=.${MAIN_DOMAIN}; path=/; max-age=604800; secure; samesite=Lax`;
    }

    const redirectUrl = adId
      ? `${CANVA_DESTINATION_URL}?epik=${encodeURIComponent(adId)}`
      : CANVA_DESTINATION_URL;

    // --- Wait for Pinterest request OR timeout ---
    Promise.race([
      eventPromise,
      new Promise(r => setTimeout(r, REDIRECT_FALLBACK_MS))
    ]).then(() => {
      console.log("[Bridge]: Pinterest event completed or timeout reached. Redirecting...");
      window.location.replace(redirectUrl);
    });
  </script>
</body>
</html>
